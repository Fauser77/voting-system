// frontend/src/services/deployService.js
import { ethers } from 'ethers';
import { BALLOT_ABI } from '../utils/contractABI';

// Bytecode do contrato compilado 
const BALLOT_BYTECODE = "0x60806040523480156200001157600080fd5b5060405162001d6838038062001d68833981810160405281019062000037919062000509565b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060008060146101000a81548160ff02191690831515021790555060005b81518110156200013d5760026040518060400160405280848481518110620000c157620000c06200055a565b5b602002602001015181526020016000815250908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000190805190602001906200011a929190620001c0565b5060208201518160010155505080806200013490620005c2565b91505062000094565b5060018060008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160016101000a81548160ff0219169083151502179055505062000675565b828054620001ce906200063f565b90600052602060002090601f016020900481019282620001f257600085556200023e565b82601f106200020d57805160ff19168380011785556200023e565b828001600101855582156200023e579182015b828111156200023d57825182559160200191906001019062000220565b5b5090506200024d919062000251565b5090565b5b808211156200026c57600081600090555060010162000252565b5090565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620002d48262000289565b810181811067ffffffffffffffff82111715620002f657620002f56200029a565b5b80604052505050565b60006200030b62000270565b9050620003198282620002c9565b919050565b600067ffffffffffffffff8211156200033c576200033b6200029a565b5b602082029050602081019050919050565b600080fd5b600080fd5b600067ffffffffffffffff8211156200037557620003746200029a565b5b620003808262000289565b9050602081019050919050565b60005b83811015620003ad57808201518184015260208101905062000390565b83811115620003bd576000848401525b50505050565b6000620003da620003d48462000357565b620002ff565b905082815260208101848484011115620003f957620003f862000352565b5b620004068482856200038d565b509392505050565b600082601f83011262000426576200042562000284565b5b815162000438848260208601620003c3565b91505092915050565b60006200045862000452846200031e565b620002ff565b905080838252602082019050602084028301858111156200047e576200047d6200034d565b5b835b81811015620004cc57805167ffffffffffffffff811115620004a757620004a662000284565b5b808601620004b689826200040e565b8552602085019450505060208101905062000480565b5050509392505050565b600082601f830112620004ee57620004ed62000284565b5b81516200050084826020860162000441565b91505092915050565b6000602082840312156200052257620005216200027a565b5b600082015167ffffffffffffffff8111156200054357620005426200027f565b5b6200055184828501620004d6565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000819050919050565b6000620005cf82620005b8565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82141562000605576200060462000589565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200065857607f821691505b602082108114156200066f576200066e62000610565b5b50919050565b6116e380620006856000396000f3fe608060405234801561001057600080fd5b50600436106100ea5760003560e01c8063a485a2761161008c578063c08cc02d11610066578063c08cc02d14610250578063d4d4b5ac1461026e578063e2ba53f01461028c578063f3cdcd1e146102aa576100ea565b8063a485a276146101f8578063ae66c9ea14610216578063b3f98adc14610234576100ea565b806365c93769116100c857806365c937691461016f5780637afdf93e1461019f5780639e7b8d61146101a9578063a3ec138d146101c5576100ea565b8063013cf08b146100ef57806335b8e82014610120578063609ff1bd14610151575b600080fd5b61010960048036038101906101049190610dde565b6102b4565b604051610117929190610eb3565b60405180910390f35b61013a60048036038101906101359190610dde565b610370565b604051610148929190610eb3565b60405180910390f35b610159610480565b6040516101669190610ee3565b60405180910390f35b61018960048036038101906101849190610f5c565b610518565b6040516101969190610fa4565b60405180910390f35b6101a7610571565b005b6101c360048036038101906101be9190610f5c565b610696565b005b6101df60048036038101906101da9190610f5c565b610892565b6040516101ef9493929190610fea565b60405180910390f35b610200610909565b60405161020d9190610fa4565b60405180910390f35b61021e61091f565b60405161022b9190610fa4565b60405180910390f35b61024e6004803603810190610249919061105b565b610932565b005b610258610b8f565b6040516102659190610ee3565b60405180910390f35b610276610b9c565b6040516102839190611088565b60405180910390f35b610294610bc0565b6040516102a191906110a3565b60405180910390f35b6102b2610c7c565b005b600281815481106102c457600080fd5b90600052602060002090600202016000915090508060000180546102e7906110f4565b80601f0160208091040260200160405190810160405280929190818152602001828054610313906110f4565b80156103605780601f1061033557610100808354040283529160200191610360565b820191906000526020600020905b81548152906001019060200180831161034357829003601f168201915b5050505050908060010154905082565b6060600060028054905083106103bb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103b290611172565b60405180910390fd5b6000600284815481106103d1576103d0611192565b5b906000526020600020906002020190508060000181600101548180546103f6906110f4565b80601f0160208091040260200160405190810160405280929190818152602001828054610422906110f4565b801561046f5780601f106104445761010080835404028352916020019161046f565b820191906000526020600020905b81548152906001019060200180831161045257829003601f168201915b505050505091509250925050915091565b600080600090506000915060005b6002805490508160ff161015610513578160028260ff16815481106104b6576104b5611192565b5b90600052602060002090600202016001015411156105005760028160ff16815481106104e5576104e4611192565b5b90600052602060002090600202016001015491508060ff1692505b808061050b906111f0565b91505061048e565b505090565b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160019054906101000a900460ff169050919050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146105ff576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105f69061128c565b60405180910390fd5b600060149054906101000a900460ff1661064e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610645906112f8565b60405180910390fd5b60008060146101000a81548160ff0219169083151502179055507f8f69ef9279bfb1fe5f4f75790947a23fa88774e98242b966bcaaf7d25e8b3c1660405160405180910390a1565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610724576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161071b9061128c565b60405180910390fd5b600160008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900460ff16156107b4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107ab90611364565b60405180910390fd5b60018060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160016101000a81548160ff02191690831515021790555080600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160036101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60016020528060005260406000206000915090508060000160009054906101000a900460ff16908060000160019054906101000a900460ff16908060000160029054906101000a900460ff16908060000160039054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905084565b60008060149054906101000a900460ff16905090565b600060149054906101000a900460ff1681565b600060149054906101000a900460ff1615610982576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610979906113d0565b60405180910390fd5b6000600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090508060000160009054906101000a900460ff1615610a17576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a0e9061143c565b60405180910390fd5b6002805490508260ff1610610a61576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a58906114a8565b60405180910390fd5b8060000160019054906101000a900460ff16610ab2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610aa990611514565b60405180910390fd5b60018160000160006101000a81548160ff021916908315150217905550818160000160026101000a81548160ff021916908360ff160217905550600160028360ff1681548110610b0557610b04611192565b5b90600052602060002090600202016001016000828254610b259190611534565b92505081905550437f26b8bb11f3c32b3756310fd2a521248252d66e44f3eb3536fca4373241956d4360028460ff1681548110610b6557610b64611192565b5b9060005260206000209060020201600001604051610b83919061161f565b60405180910390a25050565b6000600280549050905090565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60606002610bcc610480565b81548110610bdd57610bdc611192565b5b90600052602060002090600202016000018054610bf9906110f4565b80601f0160208091040260200160405190810160405280929190818152602001828054610c25906110f4565b8015610c725780601f10610c4757610100808354040283529160200191610c72565b820191906000526020600020905b815481529060010190602001808311610c5557829003601f168201915b5050505050905090565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610d0a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d019061128c565b60405180910390fd5b600060149054906101000a900460ff1615610d5a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d519061168d565b60405180910390fd5b6001600060146101000a81548160ff0219169083151502179055507f20c53179fe7c6306d9d1c279d52bae5e736f5e1178137542d3a7a9d1752691be60405160405180910390a1565b600080fd5b6000819050919050565b610dbb81610da8565b8114610dc657600080fd5b50565b600081359050610dd881610db2565b92915050565b600060208284031215610df457610df3610da3565b5b6000610e0284828501610dc9565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610e45578082015181840152602081019050610e2a565b83811115610e54576000848401525b50505050565b6000601f19601f8301169050919050565b6000610e7682610e0b565b610e808185610e16565b9350610e90818560208601610e27565b610e9981610e5a565b840191505092915050565b610ead81610da8565b82525050565b60006040820190508181036000830152610ecd8185610e6b565b9050610edc6020830184610ea4565b9392505050565b6000602082019050610ef86000830184610ea4565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610f2982610efe565b9050919050565b610f3981610f1e565b8114610f4457600080fd5b50565b600081359050610f5681610f30565b92915050565b600060208284031215610f7257610f71610da3565b5b6000610f8084828501610f47565b91505092915050565b60008115159050919050565b610f9e81610f89565b82525050565b6000602082019050610fb96000830184610f95565b92915050565b600060ff82169050919050565b610fd581610fbf565b82525050565b610fe481610f1e565b82525050565b6000608082019050610fff6000830187610f95565b61100c6020830186610f95565b6110196040830185610fcc565b6110266060830184610fdb565b95945050505050565b61103881610fbf565b811461104357600080fd5b50565b6000813590506110558161102f565b92915050565b60006020828403121561107157611070610da3565b5b600061107f84828501611046565b91505092915050565b600060208201905061109d6000830184610fdb565b92915050565b600060208201905081810360008301526110bd8184610e6b565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061110c57607f821691505b602082108114156111205761111f6110c5565b5b50919050565b7f43616e64696461746f206e616f20657869737465000000000000000000000000600082015250565b600061115c601483610e16565b915061116782611126565b602082019050919050565b6000602082019050818103600083015261118b8161114f565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006111fb82610fbf565b915060ff82141561120f5761120e6111c1565b5b600182019050919050565b7f4170656e6173206f2061646d696e6973747261646f7220706f6465206578656360008201527f7574617220657374612066756e63616f00000000000000000000000000000000602082015250565b6000611276603083610e16565b91506112818261121a565b604082019050919050565b600060208201905081810360008301526112a581611269565b9050919050565b7f4120766f746163616f206e616f20657374612070617573616461000000000000600082015250565b60006112e2601a83610e16565b91506112ed826112ac565b602082019050919050565b60006020820190508181036000830152611311816112d5565b9050919050565b7f456c6569746f72206a6120766f746f7500000000000000000000000000000000600082015250565b600061134e601083610e16565b915061135982611318565b602082019050919050565b6000602082019050818103600083015261137d81611341565b9050919050565b7f4120766f746163616f2065737461207061757361646100000000000000000000600082015250565b60006113ba601683610e16565b91506113c582611384565b602082019050919050565b600060208201905081810360008301526113e9816113ad565b9050919050565b7f566f6365206a6120766f746f7500000000000000000000000000000000000000600082015250565b6000611426600d83610e16565b9150611431826113f0565b602082019050919050565b6000602082019050818103600083015261145581611419565b9050919050565b7f50726f706f73746120696e76616c696461000000000000000000000000000000600082015250565b6000611492601183610e16565b915061149d8261145c565b602082019050919050565b600060208201905081810360008301526114c181611485565b9050919050565b7f566f6365206e616f2074656d206469726569746f206120766f746f0000000000600082015250565b60006114fe601b83610e16565b9150611509826114c8565b602082019050919050565b6000602082019050818103600083015261152d816114f1565b9050919050565b600061153f82610da8565b915061154a83610da8565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561157f5761157e6111c1565b5b828201905092915050565b60008190508160005260206000209050919050565b600081546115ac816110f4565b6115b68186610e16565b945060018216600081146115d157600181146115e357611616565b60ff1983168652602086019350611616565b6115ec8561158a565b60005b8381101561160e578154818901526001820191506020810190506115ef565b808801955050505b50505092915050565b60006020820190508181036000830152611639818461159f565b905092915050565b7f4120766f746163616f206a612065737461207061757361646100000000000000600082015250565b6000611677601983610e16565b915061168282611641565b602082019050919050565b600060208201905081810360008301526116a68161166a565b905091905056fea264697066735822122029821548924594be5247861a585fbb4391a64078c873940bb4db6c72c1042c5164736f6c63430008090033";


export const deployService = {
  // Deploy de um novo contrato de votação
  async deployNewBallot(signer, candidateNames) {
    try {
      if (!signer) throw new Error('Signer não disponível');
      
      console.log('Iniciando deploy do contrato...');
      console.log('Candidatos:', candidateNames);
      
      // Criar factory do contrato
      const BallotFactory = new ethers.ContractFactory(
        BALLOT_ABI,
        BALLOT_BYTECODE,
        signer
      );
      
      // Deploy do contrato
      const ballot = await BallotFactory.deploy(candidateNames);
      console.log('Transação de deploy enviada:', ballot.deploymentTransaction().hash);
      
      // Aguardar confirmação
      await ballot.waitForDeployment();
      
      const address = await ballot.getAddress();
      console.log('Contrato deployado em:', address);
      
      // Salvar endereço no localStorage para referência
      localStorage.setItem('deployedContractAddress', address);
      localStorage.setItem('deployedContractTime', new Date().toISOString());
      
      return {
        success: true,
        contractAddress: address,
        transactionHash: ballot.deploymentTransaction().hash
      };
      
    } catch (error) {
      console.error('Erro ao fazer deploy:', error);
      throw error;
    }
  },
  
  // Verificar se há um contrato deployado
  getDeployedContract() {
    const address = localStorage.getItem('deployedContractAddress');
    const deployTime = localStorage.getItem('deployedContractTime');
    
    if (address && deployTime) {
      return {
        address,
        deployTime: new Date(deployTime)
      };
    }
    
    return null;
  },
  
  // Limpar dados de deploy do localStorage
  clearDeployedContract() {
    localStorage.removeItem('deployedContractAddress');
    localStorage.removeItem('deployedContractTime');
  }
};